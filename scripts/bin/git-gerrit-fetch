#!/bin/bash
set -e

#------------------------------------------------------------------------------
# gerrit-fetch - Fetch the most recent patch set of a given gerrit id.
# usage: git gerrit-fetch <number>
#------------------------------------------------------------------------------
_gerrit_fetch() {
    local gerrit_id="$1"
    if [ -z "$gerrit_id" ]; then
        echo "usage: gerrit-fetch <number>" >&2
        return 1
    fi
    local ref=`ssh -p 29418 gerrit.openafs.org gerrit query --current-patch-set $gerrit_id |
               awk '/ref:/ {print $2}'`
    if [ -z "$ref" ]; then
        echo "error: failed to get ref for gerrit $gerrit_id" >&2
        return 1
    fi
    git fetch ssh://gerrit.openafs.org/openafs.git $ref
    if [ $? -ne 0 ]; then
        echo "git fetch failed" >&2
        return 1
    fi
}

_gerrit_fetch "$1"
